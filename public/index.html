<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <title>KBase</title>
  <link href="css/style.css" type="text/css" rel="stylesheet"/>
  
  <!-- knode style sheet -->
  <link href="knode/style.css" type="text/css" rel="stylesheet"/>
  <!-- jQuery and UI for draggable nodes -->
  <script type="text/javascript" src="knode/jquery/2.1.3/jquery.min.js"></script>
  <script type="text/javascript" src="knode/jqueryui/1.11.4/jquery-ui.min.js"></script>
  <!-- Raphael for SVG graphics -->
  <script type="text/javascript" src="knode/raphael/2.1.4/raphael-min.js"></script>
  <!-- Node map -->
  <script type="text/javascript" src="knode/nodemap.js"></script>
  
  <script type="text/javascript">
    
    var map, rootNode;
    
    function setDocumentHtml (document, htmlText) {
      $('#document').queue(function () {
        $('#document').html (htmlText);
        $('#document').prepend ('<div id="searchBoxPlaceHolder"></div>'); // Makes room for the searchBox
        // Enqueue the animation for the div's height to fit the entire content. This is necessary since scrollHeight
        // could not be calculated before. Now it's a valid value for the new document
        $('#document').animate({
          height: $('#document')[0].scrollHeight,
          opacity: 1
        }, 500);
        $(this).dequeue(); // Continue with the next queued animation (the one just enqueued)
      });      
    }
    
    function performPOSTDocumentRequest (document, callback) { // Load via ajax a requested document
      $.ajax({ // Ask for the parents of a node in the database
        type: "POST",
        url : "/documents/getDocument",
        data: JSON.stringify({document: document}),
        contentType: 'application/json',
        success : function(response) {
          callback (response);
        }
      });
    }
    
    function performPOSTQueryOnKbase (node, uri, callback) {
      $.ajax({ // Ask for the parents of a node in the database
        type: "POST",
        url : uri,
        data: JSON.stringify({id: node.id}),
        contentType: 'application/json',
        success : function(response) {
          $.each (response, function () {
            callback (this.id, this.document, this.text);
          });
        }
      });
    }
    
    function nodeClicked (node) { // Click handler for nodes
    
      // Only case we don't hide the current document is when we already have the requested one
      if ($.data($('#document')[0], "currentDocument") != node.href) {
        $('#document').animate({
          height:  0,
          opacity: 0
        }, 500);
      }
      
      // Make this the new root node
      node.markAsSelected ();
      
      // Remove all the map nodes which aren't this one
      $.each (map.getNodes(), function () {
        if (this != node)
          this.deleteNode ();
      });
      
      // Get all this node's parents and children through an ajax query
      performPOSTQueryOnKbase (node, "/nodes/getParentNodes", function (id, document, text) {
        node.addChildNode (id, document, text).callback = nodeClicked;
      });
      performPOSTQueryOnKbase (node, "/nodes/getChildrenNodes", function (id, document, text) {
        node.addChildNode (id, document, text).callback = nodeClicked;
      });
      
      // If there's any href (not already loaded), load the document asked
      if (node.href != undefined && $.data($('#document')[0], "currentDocument") != node.href) {
        performPOSTDocumentRequest (node.href, function (data) {
          setDocumentHtml (node.href, data);
        });
      }

      // Whatever the document asked (even undefined), store it into an HTML5 data attribute
      if (node.href != undefined)
        $.data($('#document')[0], "currentDocument", node.href);
      else
        $.data($('#document')[0], "currentDocument", null);
    }
    
    
    function initializeMapWithRoot(map) { // First-time initialize the map with the kbase root      
      $.ajax({ // Ask for the root node in the database
        type: "POST",
        url : "/nodes/getRootNode",
        success : function(response) {
          if(response.length != 1) {
            $.error ("Expected one root node for kbase, got length of "+response.length);
            return;
          }
          var rootObj = response[0]; // {document, id, text}
          // Create the root node
          rootNode = map.createRootNode (rootObj.id, rootObj.document, rootObj.text);
          rootNode.callback = nodeClicked;
          
          // Create the child nodes directly attached to the root
          $.ajax({
            type: "POST",
            url : "/nodes/getChildrenNodes",
            data: JSON.stringify({id: rootNode.id}),
            contentType: 'application/json',
            success : function(response) {
              $.each (response, function () {
                var newNode = rootNode.addChildNode(this.id, this.document, this.text);
                newNode.callback = nodeClicked;
              });
            }
          });
        }
      });
    }
    
    $(document).ready(function() {      
      map = $('#map').createNodeMap({scaleLevel: 0.55});
      rootNode = initializeMapWithRoot(map); 
    });
  </script>
  
</head>
<body>
  <div class="entirePage">
    <div id="searchBox">
      <div id="map"></div>
    </div>
    <div id="document">
      <div id="searchBoxPlaceHolder"></div>
      <!-- The document text will be loaded in here -->lots of text here<br/>lots of text here<br/>lots of text here<br/>lots of text here<br/>
      lots of text here<br/>lots of text here<br/>lots of text here<br/>lots of text here<br/>
      lots of text here<br/>lots of text here<br/>lots of text here<br/>lots of text here<br/>
      lots of text here<br/>lots of text here<br/> still lots of text...
      lots of text here<br/>lots of text here<br/>lots of text here<br/>lots of text here<br/>
      lots of text here<br/>lots of text here<br/>lots of text here<br/>lots of text here<br/>
      lots of text here<br/>lots of text here<br/>lots of text here<br/>lots of text here<br/>
      lots of text here<br/>lots of text here<br/>lots of text here<br/>lots of text here<br/>
    </div>
  </div>
</body>
</html>