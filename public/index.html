<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <title>KBase</title>
  <link href="css/style.css" type="text/css" rel="stylesheet"/>
  
  <!-- knode style sheet -->
  <link href="knode/style.css" type="text/css" rel="stylesheet"/>
  <!-- jQuery and UI for draggable nodes -->
  <script type="text/javascript" src="knode/jquery/2.1.3/jquery.min.js"></script>
  <script type="text/javascript" src="knode/jqueryui/1.11.4/jquery-ui.min.js"></script>
  <!-- Raphael for SVG graphics -->
  <script type="text/javascript" src="knode/raphael/2.1.4/raphael-min.js"></script>
  <!-- Node map -->
  <script type="text/javascript" src="knode/nodemap.js"></script>
  
  <script type="text/javascript">
    
    var map, rootNode;
    
    function performPOSTQueryOnKbase (node, uri, callback) {
      $.ajax({ // Ask for the parents of a node in the database
        type: "POST",
        url : uri,
        data: JSON.stringify({id: node.id}),
        contentType: 'application/json',
        success : function(response) {
          $.each (response, function () {
            callback (this.id, this.document, this.text);
          });
        }
      });
    }
    
    function nodeClicked (node) { // Click handler for nodes
      // Get the parent nodes in the map (not in the kbase)
      var parents = node.getParentsInMap();
      
      // Make this the new root node
      node.markAsSelected ();
      
      // Remove all the map nodes which aren't parent or this one
      $.each (map.getNodes(), function () {
        if (parents.indexOf (this) == -1 && this != node)
          this.deleteNode ();
      });
      
      // Get all this node's parents and children through an ajax query
      performPOSTQueryOnKbase (node, "/nodes/getParentNodes", function (id, document, text) {
        // If this parent wasn't in the map before..
        var notAlreadyPresentInMap = true;
        $.each (parents, function () {
          if (this.id === id) {
            notAlreadyPresentInMap = false;
            return false; // Break the jquery loop
          }
        });
        if (notAlreadyPresentInMap === true)
          node.addChildNode (id, document, text).callback = nodeClicked;
      });
      performPOSTQueryOnKbase (node, "/nodes/getChildrenNodes", function (id, document, text) {
        node.addChildNode (id, document, text).callback = nodeClicked;
      });
      
      // TODO: handle document asynchronous loading if there's any
    }
    function initializeMapWithRoot(map) { // First-time initialize the map with the kbase root      
      $.ajax({ // Ask for the root node in the database
        type: "POST",
        url : "/nodes/getRootNode",
        success : function(response) {
          if(response.length != 1) {
            $.error ("Expected one root node for kbase, got length of "+response.length);
            return;
          }
          var rootObj = response[0]; // {document, id, text}
          // Create the root node
          rootNode = map.createRootNode (rootObj.id, rootObj.document, rootObj.text);
          rootNode.callback = nodeClicked;
          
          // Create the child nodes directly attached to the root
          $.ajax({
            type: "POST",
            url : "/nodes/getChildrenNodes",
            data: JSON.stringify({id: rootNode.id}),
            contentType: 'application/json',
            success : function(response) {
              $.each (response, function () {
                var newNode = rootNode.addChildNode(this.id, this.document, this.text);
                newNode.callback = nodeClicked;
              });
            }
          });
        }
      });
    }
    
    $(document).ready(function() {      
      map = $('#map').createNodeMap({scaleLevel: 0.55});
      rootNode = initializeMapWithRoot(map); 
    });
  </script>
  
</head>
<body>
  <div class="container">
    <div id="map">
    </div>
    <div id="document">lots of text here<br/>lots of text here<br/>lots of text here<br/>lots of text here<br/>
    lots of text here<br/>lots of text here<br/>lots of text here<br/>lots of text here<br/>
    lots of text here<br/>lots of text here<br/>lots of text here<br/>lots of text here<br/>
    lots of text here<br/>lots of text here<br/> still lots of text...
    lots of text here<br/>lots of text here<br/>lots of text here<br/>lots of text here<br/>
    lots of text here<br/>lots of text here<br/>lots of text here<br/>lots of text here<br/>
    lots of text here<br/>lots of text here<br/>lots of text here<br/>lots of text here<br/>
    lots of text here<br/>lots of text here<br/>lots of text here<br/>lots of text here<br/>
    </div>
  </div>
</body>
</html>